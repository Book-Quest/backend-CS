## DB Connection Pool

### WAS - DB 연결
![image](https://github.com/user-attachments/assets/f5a4594c-0630-4bda-86bc-f212be392033)

- WAS와 DB는 평상시에 연결되어있는 것이 아니라 Request가 오는 시점에 연결하고 정보를 가져옴.
- 연결 시 TCP/IP 핸드셰이크와 같은 여러 단계를 거쳐야하므로 상당한 시간이 걸림.
- 웹에서 수많은 클라이언트가 동시다발적으로 웹서비스에 접근해서 Request들을 날리는 경우 시간 지연 문제가 발생.

⇒ DB Connection Pool을 만들어 DB 연결을 미리 해둠

### DB Connection Pool이란?

- 데이터베이스와의 연결을 미리 여러개 생성해 두고, 필요할 때마다 이를 재사용하는 기술
- 애플리케이션 서버가 시작될 때 일정 수의 데이터베이스 연결을 생성하고, 이를 풀에 저장해두었다가 필요할 때마다 할당하고 반환하는 방식으로 작동함.
- 하나의 Pool 형태로 만들어 Tomcat과 같은 미들웨어가 관리해줌

### DB 커넥션 풀을 사용하는 이유?

- 응답성을 높이기 위해 사용
- WAS - DB 연결을 하면 그에 따른 대기 지연이 발생하고 서버의 응답성이 떨어짐. 이를 막기 위해서 DB Connection Pool을 만들어 사전에 연결해놓고 관리함.

### DB 커넥션 풀의 구성 요소

- 최소 연결 수 : 풀이 관리하는 연결의 최소 개수. 애플리케이션 서버가 시작될때 이 수만큼의 연결이 미리 생성됨
- 최대 연결 수 : 풀이 관리할 수 있는 연결의 최대 개수. 동시에 처리할 수 있는 요청의 수와 직접적으로 관련이 있음
    - 너무 낮게 설정하면 동시 요청이 많을 때 응답 시간이 길어지며, 높게 설정하면 불필요한 자원을 소모
- 연결 대기 시간 : 풀에서 사용 가능한 연결을 기다리는 최대 시간. 이 시간을 초과하면 예외가 발생

## DBCP Connection Pool 연결 대기 지연 현상 - 블로그

- 수강신청, 명절 기차 예매 등의 이벤트가 있을 때, 동시에 많은 사용자가 순간적으로 몰리는 현상이 발생하기 때문에 아무리 여유있는 자원을 가진 시스템이라도 문제가 발생할 가능성이 높아짐.

![image](https://github.com/user-attachments/assets/ec39d6b5-e65d-4430-b505-85b0664734bd)

- 사용자가 몰렸을 때 DB커넥션 풀이 모자라 순간적으로 튀는 현상이 보임.
- DB 커넥션 풀이 부족할 경우 응답 시간이 튀는 현상이 발생하여 새 DB 연결을 생성하는 시간이 필요함 ⇒ DB 커넥션 풀은 부족하게 만들어두면 안됨
- 데이터베이스가 감당가능한 수준을 고려하여 DB 커넥션 풀을 설정해야함.
    - 감당가능한 수준은 성능테스트, 부하테스트 등으로 알아봐야함.
    - 발생하지 않은 장애에 대해서도 미리 대응할 수 있음
- 요청 대기 시간을 길게하면 너무 오래 기다리게 되어 반응이 늦을 수 있음
- 통신 안하는 채널을 강제로 회수할 경우 문제가 될 수 있음

---

### 참고자료

https://f-lab.kr/insight/understanding-database-connection-pool

https://engineering-skcc.github.io/cloud/tomcat/apache/DB-Pool-For-Event/
